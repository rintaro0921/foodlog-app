<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ãƒ•ãƒ¼ãƒ‰ãƒ­ã‚°ï½œãƒ¡ã‚¤ãƒ³ç”»é¢</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: "Segoe UI", sans-serif; margin: 0; transition: background 0.4s, color 0.4s; }
  header { background: orange; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
  header button { margin: 0 8px; padding: 8px 14px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
  .container { padding: 20px; }
  form input, select { padding: 6px; margin: 4px; }
  table { border-collapse: collapse; width: 100%; margin-top: 10px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
  .expired { background-color: #ffb3b3; }
  .warning { background-color: #ffd9b3; }
  .caution { background-color: #ffffb3; }
  .bottom-area { display: flex; justify-content: space-between; margin-top: 20px; }
  .chart-box, .calendar-box { width: 48%; border: 2px solid #333; border-radius: 10px; padding: 10px; }
  #chart { width: 100%; height: 100%; }
  #calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 10px; }
  .day { text-align: center; padding: 6px; border-radius: 6px; min-height: 60px; font-size: 12px; }
  .has-expiry { background-color: rgba(255, 165, 0, 0.5); }
  body.night { background: #121212; color: #e0f7ff; }
  body.night header { background: #007acc; }
  body.night .chart-box, body.night .calendar-box { border-color: #00aaff; }
  .graph-menu button { margin-right: 10px; padding: 6px 10px; border-radius: 6px; }
</style>
</head>
<body>
<header>
  <div><h2>ãƒ•ãƒ¼ãƒ‰ãƒ­ã‚°</h2></div>
  <div>
    <button onclick="window.open('https://www4.city.kanazawa.lg.jp/soshikikarasagasu/zeroc/ondankataisaku/syokuhinlosstaisaku/7494.html','_blank')">é‡‘æ²¢ãƒ•ãƒ¼ãƒ‰ãƒãƒ³ã‚¯</button>
    <button onclick="location.href='recipe.html'">ãƒ¬ã‚·ãƒ”</button>
    <button onclick="suggestRecipe()">AIãƒ¬ã‚·ãƒ”ææ¡ˆ</button>
    <button onclick="location.href='settings.html'">è¨­å®š</button>
    <!-- ğŸ”¸ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³è¿½åŠ  -->
    <button id="logoutBtn" style="background:white;color:orange;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>
</header>

<div class="container">
  <h3>é£Ÿæç™»éŒ²</h3>
  <form id="addForm">
    é£Ÿæå<input id="foodName" required>
    æ•°é‡<input id="foodQty" type="number" min="1" value="1">
    ã‚«ãƒ†ã‚´ãƒª<select id="foodCategory"></select>
    è³å‘³æœŸé™<input id="foodExp" type="date" required>
    <button>è¿½åŠ </button>
  </form>

  <table>
    <thead>
      <tr><th>é£Ÿæ</th><th>æ•°é‡</th><th>ã‚«ãƒ†ã‚´ãƒª</th><th>è³å‘³æœŸé™</th><th>æ®‹ã‚Š</th><th>æ“ä½œ</th></tr>
    </thead>
    <tbody id="table-body"></tbody>
  </table>

  <h3>åœ¨åº«ãƒ‡ãƒ¼ã‚¿åˆ†æ</h3>
  <div class="graph-menu">
    <button onclick="showGraph('expiry')">è³å‘³æœŸé™ã‚°ãƒ©ãƒ•</button>
    <button onclick="showGraph('consume')">æ¶ˆè²»é‡ã‚°ãƒ©ãƒ•</button>
    <button onclick="showGraph('trend')">æœˆåˆ¥åœ¨åº«æ¨ç§»</button>
    <button onclick="showGraph('category')">æ§‹æˆæ¯”ã‚°ãƒ©ãƒ•</button>
  </div>

  <div class="bottom-area">
    <div class="chart-box"><canvas id="chart"></canvas></div>
    <div class="calendar-box"><h3>è³å‘³æœŸé™ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h3><div id="calendar"></div></div>
  </div>
</div>

<script>
// ---------- ãƒ†ãƒ¼ãƒåˆ‡æ›¿ ----------
function applyTheme(){
  const h = new Date().getHours();
  document.body.classList.toggle("night", h < 5 || h > 18);
}
applyTheme();

// ---------- ãƒ‡ãƒ¼ã‚¿ ----------
let data = JSON.parse(localStorage.getItem("foods") || "[]");
let consumed = JSON.parse(localStorage.getItem("consumed") || "[]");
const categories = JSON.parse(localStorage.getItem("categories") || "[]");

const categorySelect = document.getElementById("foodCategory");
(categories.length ? categories.map(c=>c.name) : ["ä¹³è£½å“","è‚‰é¡","é‡èœ","æœç‰©","é£²ã¿ç‰©","èª¿å‘³æ–™"]).forEach(c=>{
  const opt = document.createElement("option");
  opt.value = c; opt.textContent = c;
  categorySelect.append(opt);
});

// ---------- é£Ÿæç™»éŒ² ----------
document.getElementById("addForm").onsubmit = async e => {
  e.preventDefault();
  const item = {
    id: Date.now(),
    name: document.getElementById("foodName").value.trim(),
    qty: Number(document.getElementById("foodQty").value),
    cat: document.getElementById("foodCategory").value,
    exp: document.getElementById("foodExp").value
  };
  if (!item.name || !item.exp) return alert("ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„");
  data.push(item);
  localStorage.setItem("foods", JSON.stringify(data));
  await saveToServer();
  alert("ç™»éŒ²ã—ã¾ã—ãŸï¼");
  render();
};

function remain(d){ return Math.ceil((new Date(d)-new Date())/86400000); }

function render(){
  const tbody = document.getElementById("table-body");
  tbody.innerHTML = "";
  data.forEach((item,i)=>{
    const diff = remain(item.exp);
    const tr = document.createElement("tr");
    if(diff<0) tr.classList.add("expired");
    else if(diff<=3) tr.classList.add("warning");
    else if(diff<=7) tr.classList.add("caution");
    tr.innerHTML = `
      <td><input value="${item.name}" onchange="editItem(${i},'name',this.value)"></td>
      <td><input type='number' value="${item.qty}" min="1" onchange="editItem(${i},'qty',this.value)"></td>
      <td>${item.cat}</td>
      <td><input type='date' value="${item.exp}" onchange="editItem(${i},'exp',this.value)"></td>
      <td>${diff}æ—¥</td>
      <td><button onclick="consumeItem(${i})">æ¶ˆè²»</button></td>`;
    tbody.append(tr);
  });
  updateChart(currentMode);
  updateCalendar();
}

function editItem(i,key,val){
  data[i][key] = val;
  localStorage.setItem("foods", JSON.stringify(data));
  saveToServer();
}

function consumeItem(i){
  consumed.push({...data[i], date:new Date().toISOString().slice(0,10)});
  data.splice(i,1);
  localStorage.setItem("foods",JSON.stringify(data));
  localStorage.setItem("consumed",JSON.stringify(consumed));
  saveToServer();
  alert("æ¶ˆè²»ã¨ã—ã¦è¨˜éŒ²ã—ã¾ã—ãŸï¼");
  render();
}

// ---------- ã‚°ãƒ©ãƒ• ----------
let chart;
let currentMode="expiry";

function showGraph(mode){ currentMode=mode; updateChart(mode); }

function updateChart(mode){
  if(chart) chart.destroy();
  const ctx=document.getElementById("chart");
  const colorMap={};
  categories.forEach(c=>colorMap[c.name]=c.color);
  if(mode==="expiry"){
    const labels=data.map(x=>x.name);
    const values=data.map(x=>remain(x.exp));
    const colors=data.map(x=>colorMap[x.cat]||"orange");
    chart=new Chart(ctx,{type:"bar",data:{labels,datasets:[{label:"è³å‘³æœŸé™ã¾ã§ã®æ—¥æ•°",data:values,backgroundColor:colors}]},options:{scales:{y:{beginAtZero:true}}}});
  }else if(mode==="consume"){
    const weekMap={};
    consumed.forEach(c=>{
      const weekStart=new Date(c.date);
      weekStart.setDate(weekStart.getDate()-weekStart.getDay());
      const key=weekStart.toISOString().slice(0,10);
      weekMap[key]=(weekMap[key]||0)+Number(c.qty||1);
    });
    const labels=Object.keys(weekMap).sort();
    const values=labels.map(k=>weekMap[k]);
    chart=new Chart(ctx,{type:"line",data:{labels,datasets:[{label:"é€±åˆ¥æ¶ˆè²»é‡",data:values,borderColor:"skyblue",fill:false}]},options:{scales:{y:{beginAtZero:true}}}});
  }else if(mode==="category"){
    const catCount={};
    data.forEach(f=>catCount[f.cat]=(catCount[f.cat]||0)+Number(f.qty));
    const labels=Object.keys(catCount);
    const values=Object.values(catCount);
    const colors=labels.map(c=>colorMap[c]||"orange");
    chart=new Chart(ctx,{type:"pie",data:{labels,datasets:[{data:values,backgroundColor:colors}]},options:{plugins:{legend:{position:"bottom"}}}});
  }else if(mode==="trend"){
    const monthMap={};
    data.forEach(f=>{
      const m=f.exp.slice(0,7);
      monthMap[m]=(monthMap[m]||0)+1;
    });
    const labels=Object.keys(monthMap).sort();
    const values=labels.map(k=>monthMap[k]);
    chart=new Chart(ctx,{type:"bar",data:{labels,datasets:[{label:"æœˆåˆ¥åœ¨åº«æ¨ç§»",data:values,backgroundColor:"orange"}]}});
  }
}

// ---------- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ ----------
function updateCalendar(){
  const cal=document.getElementById("calendar");
  cal.innerHTML="";
  const today=new Date();
  const year=today.getFullYear();
  const month=today.getMonth();
  const first=new Date(year,month,1);
  const last=new Date(year,month+1,0);
  const weekDays=["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];
  weekDays.forEach(d=>{
    const el=document.createElement("div");
    el.textContent=d;
    el.style.fontWeight="bold";
    cal.append(el);
  });
  for(let i=0;i<first.getDay();i++) cal.append(document.createElement("div"));
  for(let i=1;i<=last.getDate();i++){
    const el=document.createElement("div");
    el.className="day";
    el.textContent=i;
    const dateStr=`${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
    const expFoods=data.filter(f=>f.exp===dateStr);
    if(expFoods.length>0){
      el.classList.add("has-expiry");
      expFoods.forEach(f=>{
        const p=document.createElement("div");
        p.style.fontSize="10px";
        p.textContent=f.name;
        el.append(p);
      });
    }
    cal.append(el);
  }
}

// ---------- ã‚µãƒ¼ãƒãƒ¼é€šä¿¡ ----------
async function saveToServer() {
  await fetch("http://localhost:3000/api/foods", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    credentials: "include",
    body: JSON.stringify(data)
  });
}

async function loadFromServer() {
  const res = await fetch("http://localhost:3000/api/foods", { credentials: "include" });
  data = await res.json();
  render();
}

// ---------- AIãƒ¬ã‚·ãƒ”ææ¡ˆ ----------
async function suggestRecipe() {
  const ingredients = data.map(f => f.name);
  const res = await fetch("http://localhost:3000/api/recipes/batch", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ ingredients, k: 5 })
  });
  const result = await res.json();
  if (result.ok && result.results) {
    localStorage.setItem("ai_recipes", JSON.stringify(result.results));
    location.href = "recipe.html";
  } else {
    alert("ææ¡ˆã«å¤±æ•—ã—ã¾ã—ãŸ");
  }
}

// ---------- ğŸ”¸ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½ ----------
document.getElementById("logoutBtn").addEventListener("click", async () => {
  if (!confirm("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ")) return;
  try {
    const res = await fetch("http://localhost:3000/api/logout", {
      method: "POST",
      credentials: "include"
    });
    const result = await res.json();
    if (result.ok) {
      alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ");
      localStorage.clear();
      window.location.href = "index.html";
    } else {
      alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ");
    }
  } catch (err) {
    alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
    console.error(err);
  }
});

render();
</script>
</body>
</html>
